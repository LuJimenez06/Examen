<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Maestro - Exámenes Creados</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Estilos CSS existentes */
        h1 {
            color: #333;
            text-align: center;
        }

        #materiaSelect, #examenSelect, #cargarExamen, #asignarExamen {
            padding: 10px;
            font-size: 1em;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 100%;
            max-width: 300px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        #cuestionario {
            margin-top: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .pregunta {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #fafafa;
        }

        .pregunta p {
            margin: 0;
            font-weight: bold;
        }

        label {
            display: block;
            margin: 5px 0;
            font-size: 0.9em;
        }

        input[type="text"] {
            width: calc(100% - 20px);
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        #tituloExamen {
            text-align: center;
            font-size: 1.5em;
            color: #555;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <!-- Barra de navegación -->
    <nav class="navbar">
        <div class="navbar-brand">Panel de Maestro</div>
        <ul class="navbar-menu">
            <li><a href="maestro.html">Inicio</a></li>
            <li><a href="datos_maestro.html">Datos</a></li>
            <li class="dropdown">
                <a href="#" onclick="toggleDropdown(event)">Ver Exámenes</a>
                <div class="dropdown-content">
                    <a href="crear_examen.html">Crear Examen</a>
                    <a href="ver_examenes.html">Preview de Examen</a>
                    <a href="imprimir_examen.html">Imprimir Examen</a>
                    <a href="calificar_examen.html">Calificar Examen</a>
                    <a href="resultados_examenes.html">Resultados de Exámenes</a>
                </div>
            </li>
            <li><a href="index.html">Cerrar Sesión</a></li>
        </ul>
    </nav>

    <h1>Exámenes Creados</h1>
    
    <!-- Selector de Materia -->
    <select id="materiaSelect">
        <option value="">Selecciona una Materia</option>
        <option value="Matematicas">Matemáticas</option>
        <!-- Agrega más materias según sea necesario -->
    </select>
    
    <!-- Selector de Examen -->
    <select id="examenSelect">
        <option value="">Selecciona un Examen</option>
    </select>
    <button id="cargarExamen">Cargar Examen</button>
    <h2 id="tituloExamen"></h2> <!-- Elemento para mostrar el título del examen -->
    <div id="cuestionario"></div>
    <button id="asignarExamen">Asignar Examen a los Alumnos</button>

    <!-- Firebase y JavaScript -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCjRRBzlhKPtp74LoxjHpgPlg-CtGLyg-Y",
            authDomain: "examen-e836d.firebaseapp.com",
            projectId: "examen-e836d",
            storageBucket: "examen-e836d.appspot.com",
            messagingSenderId: "900551617182",
            appId: "1:900551617182:web:3925b64bd5579711d1e98f",
            databaseURL: "https://examen-e836d-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const materiaSelect = document.getElementById("materiaSelect");
        const examenSelect = document.getElementById("examenSelect");
        const cargarExamenBtn = document.getElementById("cargarExamen");
        const asignarExamenBtn = document.getElementById("asignarExamen");
        const cuestionarioDiv = document.getElementById("cuestionario");
        const tituloExamen = document.getElementById("tituloExamen");

        // Al cambiar la materia, carga los exámenes correspondientes
        materiaSelect.addEventListener("change", () => {
            const materiaSeleccionada = materiaSelect.value;
            examenSelect.innerHTML = '<option value="">Selecciona un Examen</option>';

            if (materiaSeleccionada) {
                onValue(ref(database, 'examenes'), (snapshot) => {
                    const examenes = snapshot.val();

                    for (let id in examenes) {
                        const examen = examenes[id];
                        if (examen.materia === materiaSeleccionada) {
                            const option = document.createElement("option");
                            option.value = id;
                            option.textContent = examen.nombre ? examen.nombre : "Título no disponible";
                            examenSelect.appendChild(option);
                        }
                    }
                }, (error) => {
                    console.error("Error al cargar los exámenes:", error);
                    alert("Hubo un error al cargar los exámenes.");
                });
            }
        });

        // Cargar preguntas del examen seleccionado
        cargarExamenBtn.addEventListener("click", () => {
            const examenId = examenSelect.value;
            if (examenId) {
                // Cargar el nombre del examen
                onValue(ref(database, `examenes/${examenId}`), (snapshot) => {
                    const examen = snapshot.val();
                    if (examen) { // Verifica que el examen no sea nulo
                        tituloExamen.textContent = examen.nombre ? examen.nombre : "Título no disponible";
                    } else {
                        alert("No se encontró el examen seleccionado.");
                    }
                });
            
                // Cargar las preguntas del examen
                onValue(ref(database, `examenes/${examenId}/preguntas`), (snapshot) => {
                    const preguntas = snapshot.val();
                    cuestionarioDiv.innerHTML = ''; // Limpiar cuestionario antes de mostrar el nuevo
            
                    if (preguntas) {
                        for (let id in preguntas) {
                            const preguntaObj = preguntas[id];
                            const preguntaDiv = document.createElement("div");
                            preguntaDiv.classList.add("pregunta");
            
                            // Agregar la pregunta
                            preguntaDiv.innerHTML = `<p><strong>Pregunta:</strong> ${preguntaObj.pregunta}</p>`;
            
                            if (preguntaObj.opciones) {
                                preguntaDiv.innerHTML += `<div>`;
                                for (const [key, value] of Object.entries(preguntaObj.opciones)) {
                                    preguntaDiv.innerHTML += `<label><input type="radio" name="${id}" value="${key}"> ${key}: ${value}</label><br>`;
                                }
                                preguntaDiv.innerHTML += `</div>`;
                            }
            
                            cuestionarioDiv.appendChild(preguntaDiv);
                        }
                    } else {
                        cuestionarioDiv.innerHTML = '<p>No hay preguntas disponibles para este examen.</p>'; // Mensaje si no hay preguntas
                    }
                });
            } else {
                alert("Por favor, selecciona un examen.");
            }
        });

        // Asignar examen a los alumnos registrados en la materia
        asignarExamenBtn.addEventListener("click", () => {
            const examenId = examenSelect.value;
            const materiaSeleccionada = materiaSelect.options[materiaSelect.selectedIndex].text;

            if (!examenId) {
                alert("Por favor, selecciona un examen.");
                return;
            }

            // Obtener la lista de alumnos
            onValue(ref(database, 'students'), (snapshot) => {
                const alumnos = snapshot.val();
                const examenesRef = ref(database, `examenes/${examenId}/asignaciones`);

                // Crear un objeto para almacenar las asignaciones
                let asignaciones = {};
                let contadorAlumnosAsignados = 0; // Inicializa el contador de alumnos asignados

                console.log("Materia seleccionada:", materiaSeleccionada);
                console.log("Alumnos obtenidos:", alumnos);

                for (let id in alumnos) {
                    const alumno = alumnos[id];
                    let estaEnMateria = false;

                    // Verificar cada ficha del alumno para ver si está en la materia seleccionada
                    if (alumno.fichas) {
                        for (let fichaKey in alumno.fichas) {
                            const ficha = alumno.fichas[fichaKey];
                            console.log(`Revisando ficha de ${alumno.nombre || id}:`, ficha);

                            // Verificar si la materia coincide
                            if (ficha.materia === materiaSeleccionada) {
                                estaEnMateria = true; // Marcar que el alumno está en la materia
                                break; // No es necesario seguir revisando las fichas
                            }
                        }
                    }

                    if (estaEnMateria) {
                        console.log(`Asignando examen a ${alumno.nombre || id}`);
                        asignaciones[id] = true; // Marcar el examen como asignado a este estudiante
                        contadorAlumnosAsignados++; // Incrementar el contador
                    }
                }

                // Realizar la actualización en Firebase con un solo update
                update(examenesRef, asignaciones)
                    .then(() => {
                        // Construir el mensaje de confirmación con el número de alumnos
                        const mensaje = `Examen asignado a ${contadorAlumnosAsignados} alumno(s) registrados en la materia de ${materiaSeleccionada}.`;
                        alert(mensaje);
                    })
                    .catch((error) => {
                        console.error("Error al asignar el examen:", error);
                        alert("Hubo un error al asignar el examen.");
                    });
            }, (error) => {
                console.error("Error al obtener los alumnos:", error);
                alert("Hubo un error al obtener la lista de alumnos.");
            });
        });
    </script>
</body>
</html>
